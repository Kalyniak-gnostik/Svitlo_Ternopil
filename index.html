<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–≤—ñ—Ç–ª–∞ –¢–µ—Ä–Ω–æ–ø—ñ–ª—å</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --text: #333;
            --green: #2ecc71;
            --red: #e74c3c;
            --yellow: #f1c40f;
            --gray: #95a5a6;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* HEADER */
        header { text-align: center; margin-bottom: 30px; }
        h1 { margin: 0; font-size: 1.5rem; color: var(--primary); }
        .subtitle { font-size: 0.9rem; color: #7f8c8d; margin-top: 5px; }

        /* CONTROLS */
        .controls { background: var(--card-bg); padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; text-align: center; }
        
        select { width: 100%; max-width: 300px; padding: 12px; border: 2px solid #eee; border-radius: 8px; font-size: 16px; background: white; cursor: pointer; margin-bottom: 15px; }
        select:focus { border-color: var(--accent); outline: none; }

        .btn-find {
            background: var(--accent); color: white; border: none; padding: 12px 24px; 
            border-radius: 8px; font-size: 16px; cursor: pointer; transition: 0.2s; width: 100%; max-width: 300px;
        }
        .btn-find:hover { background: #2980b9; }

        /* WIZARD (SEARCH) */
        .wizard-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;
        }
        .wizard-content {
            background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px;
            position: relative; animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .wizard-step { display: none; }
        .wizard-step.active { display: block; }
        .wizard-header { font-weight: bold; margin-bottom: 15px; font-size: 1.1rem; }
        .close-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #aaa; }
        
        .wiz-btn { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: 1px solid #ddd; background: white; text-align: left; cursor: pointer; }
        .wiz-btn:hover { background: #f0f0f0; }

        /* SCHEDULE VISUALIZATION */
        .schedule-card {
            background: var(--card-bg); padding: 20px; border-radius: 15px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px;
            display: none; /* –ü—Ä–∏—Ö–æ–≤–∞–Ω–æ –ø–æ–∫–∏ –Ω–µ –æ–±—Ä–∞–Ω–∞ –≥—Ä—É–ø–∞ */
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .card-title { font-weight: bold; font-size: 1.2rem; }
        .date-badge { background: #eee; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; color: #555; }

        /* TIMELINE BAR */
        .timeline-wrapper { position: relative; margin-top: 20px; margin-bottom: 10px; }
        .timeline { display: flex; height: 35px; border-radius: 8px; overflow: hidden; }
        .hour-block { flex: 1; border-right: 1px solid rgba(255,255,255,0.2); position: relative; }
        .hour-block:last-child { border-right: none; }
        
        /* COLORS */
        .bg-on { background: var(--green); }
        .bg-off { background: var(--red); }
        .bg-maybe { background: var(--yellow); }
        .bg-unknown { background: var(--gray); }

        /* LABELS */
        .time-labels { display: flex; justify-content: space-between; font-size: 0.7rem; color: #888; margin-top: 5px; padding: 0 2px; }

        /* LEGEND */
        .legend { display: flex; gap: 15px; justify-content: center; margin-top: 15px; font-size: 0.8rem; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>–ì—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–≤—ñ—Ç–ª–∞<br>–¢–µ—Ä–Ω–æ–ø—ñ–ª—å</h1>
        <div class="subtitle" id="lastUpdated">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</div>
    </header>

    <div class="controls">
        <label for="mainGroupSelect" style="display:block; margin-bottom:10px; color:#555;">–í–∞—à–∞ —á–µ—Ä–≥–∞:</label>
        <select id="mainGroupSelect" onchange="renderAll(this.value)">
            <option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É</option>
            <option value="1.1">1.1</option>
            <option value="1.2">1.2</option>
            <option value="2.1">2.1</option>
            <option value="2.2">2.2</option>
            <option value="3.1">3.1</option>
            <option value="3.2">3.2</option>
            <option value="4.1">4.1</option>
            <option value="4.2">4.2</option>
            <option value="5.1">5.1</option>
            <option value="5.2">5.2</option>
            <option value="6.1">6.1</option>
            <option value="6.2">6.2</option>
        </select>
        
        <button class="btn-find" onclick="openWizard()">üîç –ó–Ω–∞–π—Ç–∏ —Å–≤–æ—é –≥—Ä—É–ø—É</button>
    </div>

    <div id="cardToday" class="schedule-card">
        <div class="card-header">
            <span class="card-title">–°—å–æ–≥–æ–¥–Ω—ñ</span>
            <span class="date-badge" id="dateToday">--.--</span>
        </div>
        <div id="vizToday"></div>
        <div class="legend">
            <div class="legend-item"><div class="dot" style="background:var(--green)"></div>–Ñ</div>
            <div class="legend-item"><div class="dot" style="background:var(--red)"></div>–ù–µ–º–∞—î</div>
            <div class="legend-item"><div class="dot" style="background:var(--yellow)"></div>–ú–æ–∂–ª–∏–≤–æ</div>
        </div>
    </div>

    <div id="cardTomorrow" class="schedule-card">
        <div class="card-header">
            <span class="card-title">–ó–∞–≤—Ç—Ä–∞</span>
            <span class="date-badge" id="dateTomorrow">--.--</span>
        </div>
        <div id="vizTomorrow"></div>
        <div class="legend">
            <div class="legend-item"><div class="dot" style="background:var(--green)"></div>–Ñ</div>
            <div class="legend-item"><div class="dot" style="background:var(--red)"></div>–ù–µ–º–∞—î</div>
            <div class="legend-item"><div class="dot" style="background:var(--yellow)"></div>–ú–æ–∂–ª–∏–≤–æ</div>
        </div>
    </div>
</div>

<div class="wizard-modal" id="wizard">
    <div class="wizard-content">
        <span class="close-btn" onclick="closeWizard()">&times;</span>
        
        <div class="wizard-step active" id="step1">
            <div class="wizard-header">üèô –ö—Ä–æ–∫ 1: –û–±–µ—Ä—ñ—Ç—å –Ω–∞—Å–µ–ª–µ–Ω–∏–π –ø—É–Ω–∫—Ç</div>
            <select id="wizCity" onchange="wizNextStep(1)"></select>
        </div>

        <div class="wizard-step" id="step2">
            <div class="wizard-header">üõ£ –ö—Ä–æ–∫ 2: –û–±–µ—Ä—ñ—Ç—å –≤—É–ª–∏—Ü—é</div>
            <select id="wizStreet" onchange="wizNextStep(2)"></select>
            <div style="margin-top:10px; font-size:0.8rem; color:#888; text-align:center" onclick="stepBack(2)">üîô –ù–∞–∑–∞–¥</div>
        </div>

        <div class="wizard-step" id="step3">
            <div class="wizard-header">üè† –ö—Ä–æ–∫ 3: –ù–æ–º–µ—Ä –±—É–¥–∏–Ω–∫—É</div>
            <select id="wizHouse" onchange="wizFinish()"></select>
            <div style="margin-top:10px; font-size:0.8rem; color:#888; text-align:center" onclick="stepBack(3)">üîô –ù–∞–∑–∞–¥</div>
        </div>
    </div>
</div>

<script>
    // üî• –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø (–í–∞—à—ñ –¥–∞–Ω—ñ –≤–∂–µ –≤–ø–∏—Å–∞–Ω—ñ)
    const GITHUB_USER = 'kalyniak-gnostik'; 
    const REPO_NAME = 'Svitlo_Ternopil';
    
    const DATA_URL = `https://raw.githubusercontent.com/${GITHUB_USER}/${REPO_NAME}/main`;

    let globalSchedule = null;
    let globalAddressDB = null;

    async function init() {
        try {
            // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≥—Ä–∞—Ñ—ñ–∫
            const sRes = await fetch(`${DATA_URL}/schedule.json`);
            if(sRes.ok) {
                globalSchedule = await sRes.json();
                document.getElementById('lastUpdated').innerText = `–û–Ω–æ–≤–ª–µ–Ω–æ: ${globalSchedule.updated_at}`;
                
                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î –∑–±–µ—Ä–µ–∂–µ–Ω–∞ –≥—Ä—É–ø–∞, —â–æ–± –æ–¥—Ä–∞–∑—É –ø–æ–∫–∞–∑–∞—Ç–∏
                const savedGroup = localStorage.getItem('myGroup');
                if(savedGroup) {
                    document.getElementById('mainGroupSelect').value = savedGroup;
                    renderAll(savedGroup);
                }
            } else {
                document.getElementById('lastUpdated').innerText = "–ì—Ä–∞—Ñ—ñ–∫ –ø–æ–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π";
            }

            // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∞–¥—Ä–µ—Å–∏ (–¥–ª—è –ø–æ—à—É–∫—É)
            const aRes = await fetch(`${DATA_URL}/addresses.json`);
            if(aRes.ok) {
                globalAddressDB = await aRes.json();
            }

        } catch(e) {
            console.error(e);
            document.getElementById('lastUpdated').innerText = "–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è (GitHub Raw)";
        }
    }

    // --- –†–ï–ù–î–ï–†–ò–ù–ì –ì–†–ê–§–Ü–ö–Ü–í ---
    function renderAll(group) {
        if (!group || !globalSchedule) return;
        localStorage.setItem('myGroup', group); // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤–∏–±—ñ—Ä

        renderDay(group, 'today', 'cardToday', 'vizToday', 'dateToday');
        renderDay(group, 'tomorrow', 'cardTomorrow', 'vizTomorrow', 'dateTomorrow');
    }

    function renderDay(group, dayKey, cardId, vizId, dateId) {
        const card = document.getElementById(cardId);
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –¥–∞–Ω–∏—Ö
        if (!globalSchedule[dayKey] || !globalSchedule[dayKey].data || !globalSchedule[dayKey].data[group]) {
            card.style.display = 'none';
            return;
        }

        const dayData = globalSchedule[dayKey];
        card.style.display = 'block';
        document.getElementById(dateId).innerText = dayData.date;
        
        const schedule = dayData.data[group];
        const vizContainer = document.getElementById(vizId);
        
        // –ì–µ–Ω–µ—Ä—É—î–º–æ —Å–º—É–∂–∫—É
        let html = '<div class="timeline-wrapper"><div class="timeline">';
        
        // –°–æ—Ä—Ç—É—î–º–æ –∫–ª—é—á—ñ —á–∞—Å—É (00:00, 00:30, ...)
        const times = Object.keys(schedule).sort();
        
        times.forEach(time => {
            const status = schedule[time];
            let colorClass = 'bg-unknown';
            if(status === 'on') colorClass = 'bg-on';
            if(status === 'off') colorClass = 'bg-off';
            if(status === 'maybe') colorClass = 'bg-maybe';
            
            html += `<div class="hour-block ${colorClass}" title="${time}: ${status}"></div>`;
        });
        
        html += '</div><div class="time-labels">';
        html += '<span>00:00</span><span>06:00</span><span>12:00</span><span>18:00</span><span>23:30</span>';
        html += '</div></div>';

        vizContainer.innerHTML = html;
    }

    // --- –õ–û–ì–Ü–ö–ê –ü–û–®–£–ö–£ (WIZARD) ---
    function openWizard() {
        if(!globalAddressDB) { alert("–ë–∞–∑–∞ –∞–¥—Ä–µ—Å —â–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è, —Å–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥..."); return; }
        document.getElementById('wizard').style.display = 'flex';
        populateCity();
        showStep(1);
    }

    function closeWizard() {
        document.getElementById('wizard').style.display = 'none';
    }

    function showStep(n) {
        [1,2,3].forEach(i => document.getElementById(`step${i}`).classList.remove('active'));
        document.getElementById(`step${n}`).classList.add('active');
    }

    function stepBack(curr) {
        showStep(curr - 1);
    }

    function populateCity() {
        // –£–Ω—ñ–∫–∞–ª—å–Ω—ñ –º—ñ—Å—Ç–∞, —Å–æ—Ä—Ç–æ–≤–∞–Ω—ñ
        const cities = [...new Set(globalAddressDB.map(i => i.c))].sort();
        const sel = document.getElementById('wizCity');
        sel.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å...</option>';
        cities.forEach(c => sel.add(new Option(c, c)));
    }

    function wizNextStep(step) {
        if (step === 1) {
            const city = document.getElementById('wizCity').value;
            if(!city) return;
            
            const streets = [...new Set(globalAddressDB.filter(i => i.c === city).map(i => i.s))].sort();
            const sel = document.getElementById('wizStreet');
            sel.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å...</option>';
            streets.forEach(s => sel.add(new Option(s, s)));
            showStep(2);
        }
        if (step === 2) {
            const city = document.getElementById('wizCity').value;
            const street = document.getElementById('wizStreet').value;
            if(!street) return;

            const houses = globalAddressDB.filter(i => i.c === city && i.s === street);
            const sel = document.getElementById('wizHouse');
            
            // –Ø–∫—â–æ –¥–ª—è –≤—Å—ñ—î—ó –≤—É–ª–∏—Ü—ñ –æ–¥–Ω–∞ –≥—Ä—É–ø–∞
            const uniqueGroups = [...new Set(houses.map(h => h.g))];
            if(uniqueGroups.length === 1) {
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–≤–µ—Ä—à—É—î–º–æ, —è–∫—â–æ –≥—Ä—É–ø–∞ –æ–¥–Ω–∞ –Ω–∞ –≤—Å—é –≤—É–ª–∏—Ü—é
                finishSearch(uniqueGroups[0]);
                return;
            }

            sel.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å...</option>';
            // –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –Ω–æ–º–µ—Ä—ñ–≤ –±—É–¥–∏–Ω–∫—ñ–≤ (–Ω–∞–º–∞–≥–∞—î–º–æ—Å—å —è–∫ —á–∏—Å–ª–∞)
            houses.sort((a,b) => a.h.localeCompare(b.h, undefined, {numeric: true}))
                  .forEach(h => sel.add(new Option(h.h, h.g)));
            showStep(3);
        }
    }

    function wizFinish() {
        const group = document.getElementById('wizHouse').value;
        finishSearch(group);
    }

    function finishSearch(group) {
        if(!group) return;
        closeWizard();
        document.getElementById('mainGroupSelect').value = group;
        renderAll(group);
        alert(`–í–∞—à—É –∞–¥—Ä–µ—Å—É –∑–Ω–∞–π–¥–µ–Ω–æ! –¶–µ —á–µ—Ä–≥–∞ ${group}`);
    }

    // –ó–∞–ø—É—Å–∫
    init();
</script>

</body>
</html>