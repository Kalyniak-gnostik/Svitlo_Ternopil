<!DOCTYPE html>
<html lang="uk">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6DZW6D0LRN"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-6DZW6D0LRN');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%239b59b6'/%3E%3Cpath d='M58 15 L28 52 H52 L42 85 L72 40 H48 Z' fill='%23f1c40f' stroke='white' stroke-width='2' stroke-linejoin='round'/%3E%3C/svg%3E">
    
    <title>–ì—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–≤—ñ—Ç–ª–∞ –¢–µ—Ä–Ω–æ–ø—ñ–ª—å (–ì–ü–í) | –û–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–∂–∏–≤–æ</title>
    <meta name="description" content="–ê–∫—Ç—É–∞–ª—å–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫ –ø–æ–≥–æ–¥–∏–Ω–Ω–∏—Ö –≤—ñ–¥–∫–ª—é—á–µ–Ω—å –µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—ó (–ì–ü–í) –≤ –¢–µ—Ä–Ω–æ–ø–æ–ª—ñ —Ç–∞ –æ–±–ª–∞—Å—Ç—ñ. –ü–æ—à—É–∫ —á–µ—Ä–≥–∏ –∑–∞ –∞–¥—Ä–µ—Å–æ—é. –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ —Ç–∞ –∑–∞–≤—Ç—Ä–∞. –í—Å—ñ –≥—Ä—É–ø–∏.">
    
    <style>
        /* === DESIGN SYSTEM === */
        :root {
            --font-main: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Inter", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --bg-body: #f5f5f7;
            --bg-card: #ffffff;
            --bg-input: #f0f0f5;
            --text-main: #1d1d1f;
            --text-sub: #86868b;
            --accent: #9b59b6; 
            --accent-hover: #8e44ad;
            --accent-glow: rgba(155, 89, 182, 0.4);
            --green: #34c759; --green-bg: #e1fae6;
            --red: #ff3b30; --red-bg: #ffebeb;
            --yellow: #ffcc00; --yellow-bg: #fff9d6;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-lg: 0 12px 30px rgba(0,0,0,0.08);
            --radius-lg: 22px;
            --radius-md: 14px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: #000000;
                --bg-card: #1c1c1e;
                --bg-input: #2c2c2e;
                --text-main: #f5f5f7;
                --text-sub: #98989d;
                --shadow-sm: 0 2px 8px rgba(0,0,0,0.2);
                --shadow-lg: 0 12px 30px rgba(0,0,0,0.3);
                --green-bg: rgba(52, 199, 89, 0.15);
                --red-bg: rgba(255, 59, 48, 0.15);
                --yellow-bg: rgba(255, 204, 0, 0.15);
            }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; padding: 0; font-family: var(--font-main); 
            background: var(--bg-body); color: var(--text-main); 
            min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden;
        }
        
        .container { 
            max-width: 640px; margin: 0 auto; padding: 20px 16px; 
            width: 100%; flex: 1; display: flex; flex-direction: column; 
        }

        /* === TOP BAR === */
        .top-bar {
            display: flex; justify-content: space-between; width: 100%; margin-bottom: 10px;
        }
        .btn-top {
            font-size: 13px; font-weight: 700; color: var(--accent);
            text-decoration: none; background: var(--bg-card);
            padding: 8px 14px; border-radius: 20px;
            box-shadow: var(--shadow-sm); display: flex; align-items: center; gap: 6px;
            transition: transform 0.2s;
        }
        .btn-top:active { transform: scale(0.95); }

        /* === HEADER === */
        header { display: flex; flex-direction: column; align-items: center; margin-bottom: 24px; text-align: center; }
        h1 { margin: 12px 0 8px 0; font-size: 26px; font-weight: 800; letter-spacing: -0.5px; }
        
        .status-badge { 
            background: var(--bg-card); padding: 8px 16px; border-radius: 30px; 
            font-size: 13px; font-weight: 600; color: var(--text-sub); 
            display: flex; align-items: center; gap: 8px; box-shadow: var(--shadow-sm);
        }
        .dot { width: 8px; height: 8px; background: var(--green); border-radius: 50%; animation: pulse 2s infinite; }
        .dot.error { background: var(--red); animation: none; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(52, 199, 89, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(52, 199, 89, 0); } 100% { box-shadow: 0 0 0 0 rgba(52, 199, 89, 0); } }

        /* === ACTIONS === */
        .actions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
        .btn-main {
            border: none; padding: 16px; border-radius: var(--radius-md);
            font-weight: 700; font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            text-decoration: none; transition: transform 0.1s;
        }
        .btn-main:active { transform: scale(0.97); }
        .btn-tg { background: #229ED9; color: white; box-shadow: 0 4px 15px rgba(34, 158, 217, 0.3); }
        .btn-search { background: var(--accent); color: white; box-shadow: 0 4px 15px var(--accent-glow); }

        /* === SCROLLER === */
        .scroller-container { margin-bottom: 30px; }
        .group-track-wrapper {
            position: relative; margin: 0 -16px; height: 70px; overflow: hidden;
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        }
        .group-track {
            display: flex; gap: 12px; padding: 0 50%; align-items: center; overflow-x: auto;
            scrollbar-width: none; position: absolute; left: 0; right: 0; top: 0; bottom: 0;
        }
        .btn-group {
            flex: 0 0 auto; width: 56px; height: 56px; background: var(--bg-card);
            border-radius: 18px; display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 16px; color: var(--text-sub);
            box-shadow: var(--shadow-sm); transition: all 0.2s; border: 2px solid transparent;
        }
        .btn-group.active {
            background: var(--bg-card); color: var(--accent); border-color: var(--accent);
            box-shadow: 0 4px 15px var(--accent-glow); transform: scale(1.1); z-index: 2;
        }
        .scroll-hint { text-align: center; font-size: 12px; color: var(--text-sub); margin-top: 8px; opacity: 0.7; }

        /* === CARD === */
        .card {
            background: var(--bg-card); border-radius: var(--radius-lg);
            padding: 24px; box-shadow: var(--shadow-lg); margin-bottom: 30px;
            display: flex; flex-direction: column; align-items: center; animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .day-switch { background: var(--bg-input); padding: 5px; border-radius: 18px; display: flex; width: 100%; margin-bottom: 24px; }
        .day-opt {
            flex: 1; border: none; background: transparent; padding: 12px;
            border-radius: 14px; font-weight: 700; font-size: 14px; color: var(--text-sub);
            cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: 0.2s;
        }
        .day-opt.active { background: var(--accent); color: white; box-shadow: 0 4px 12px var(--accent-glow); }
        .day-opt span { font-size: 11px; opacity: 0.8; margin-top: 2px; }

        .no-sched-msg { display: none; width: 100%; text-align: center; background: var(--bg-input); color: var(--text-sub); padding: 12px; border-radius: var(--radius-md); margin-bottom: 20px; font-size: 14px; font-weight: 600; }

        .group-display { width: 100%; text-align: center; margin-bottom: 20px; }
        .group-display-inner {
            display: inline-flex; align-items: center; justify-content: center;
            width: 80px; height: 80px; border-radius: 26px; background: var(--bg-body);
            color: var(--accent); font-size: 32px; font-weight: 900;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.05); border: 2px solid var(--accent);
        }
        .group-display-label { display: block; font-size: 12px; color: var(--text-sub); text-transform: uppercase; font-weight: 700; margin-bottom: 10px; }

        .schedule-list { width: 100%; display: flex; flex-direction: column; position: relative; }
        .schedule-list::before { content: ''; position: absolute; left: 28px; top: 15px; bottom: 15px; width: 2px; background: var(--bg-input); z-index: 0; }
        
        .row { display: flex; align-items: center; gap: 16px; padding: 12px 0; position: relative; z-index: 1; }
        .time-box {
            background: var(--bg-card); border: 2px solid var(--bg-input); width: 60px; text-align: center;
            padding: 6px 0; border-radius: 10px; font-weight: 700; font-size: 13px; color: var(--text-main);
        }
        .status-box {
            flex: 1; padding: 14px 18px; border-radius: 16px; display: flex; justify-content: space-between;
            align-items: center; font-weight: 600; font-size: 15px;
        }
        .row.on .status-box { background: var(--green-bg); color: var(--green); }
        .row.on .time-box { border-color: var(--green); color: var(--green); }
        .row.off .status-box { background: var(--red-bg); color: var(--red); }
        .row.off .time-box { border-color: var(--red); color: var(--red); }
        .row.maybe .status-box { background: var(--yellow-bg); color: #dcb000; }
        .row.maybe .time-box { border-color: var(--yellow); color: #dcb000; }
        
        .btn-share {
            margin-top: 24px; width: 100%; padding: 16px; border-radius: var(--radius-md);
            border: 2px dashed var(--accent); background: rgba(155, 89, 182, 0.05);
            color: var(--accent); font-weight: 700; cursor: pointer;
        }
        .empty-state { text-align: center; color: var(--text-sub); padding: 40px 0; font-style: italic; width: 100%; }

        /* === FOOTER === */
        footer { margin-top: auto; padding-top: 40px; padding-bottom: 20px; text-align: center; color: var(--text-sub); font-size: 13px; line-height: 1.6; border-top: 1px solid rgba(0,0,0,0.05); }
        footer h2 { font-size: 14px; color: var(--text-main); margin-bottom: 8px; }

        /* === WIZARD (SEARCH MODAL) === */
        .wiz-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(12px); z-index: 999; justify-content: center; align-items: flex-end; /* Mobile friendly: bottom sheet look on small screens if desired, or center */ }
        
        .wiz-box { 
            background: var(--bg-card); width: 100%; max-width: 500px; height: 85vh; /* Fixed height for scrollable content */
            border-top-left-radius: 28px; border-top-right-radius: 28px; 
            box-shadow: var(--shadow-lg); display: flex; flex-direction: column; 
            overflow: hidden; /* Prevent body scroll */
        }

        @media (min-width: 500px) {
            .wiz-overlay { align-items: center; }
            .wiz-box { height: 600px; border-radius: 28px; }
        }

        .wiz-head { 
            flex: 0 0 auto; padding: 20px 24px; border-bottom: 1px solid var(--bg-input); 
            font-weight: 800; font-size: 18px; display: flex; justify-content: space-between; align-items: center; background: var(--bg-card);
        }
        .wiz-close { font-size: 24px; padding: 10px; cursor: pointer; color: var(--text-sub); }

        .wiz-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        .step-container { display: flex; flex-direction: column; height: 100%; width: 100%; }

        .wiz-input-fixed { 
            flex: 0 0 auto; padding: 16px 20px; background: var(--bg-card); 
            border-bottom: 1px solid var(--bg-input); z-index: 10;
        }
        
        .wiz-input-wrap { position: relative; }
        .wiz-icon { position: absolute; left: 14px; top: 14px; opacity: 0.5; font-size: 18px; }
        .wiz-inp { 
            width: 100%; padding: 14px; padding-left: 44px; background: var(--bg-input); 
            border-radius: 14px; border: 2px solid transparent; font-size: 16px; outline: none; font-family: inherit;
        }
        .wiz-inp:focus { background: var(--bg-card); border-color: var(--accent); }

        .wiz-list-scroll { 
            flex: 1; overflow-y: auto; padding: 10px 0; 
            -webkit-overflow-scrolling: touch; 
        }

        .wiz-item { 
            padding: 16px 24px; border-bottom: 1px solid var(--bg-input); cursor: pointer; 
            font-weight: 500; font-size: 15px; display: flex; justify-content: space-between; align-items: center;
            transition: background 0.1s;
        }
        .wiz-item:active { background: var(--bg-input); }
        .wiz-item:last-child { border-bottom: none; }

        .wiz-back { 
            text-align: center; padding: 16px; color: var(--accent); font-weight: 600; font-size: 14px; 
            cursor: pointer; border-top: 1px solid var(--bg-input); background: var(--bg-card);
            flex: 0 0 auto;
        }
    </style>
	<link rel="canonical" href="https://grafik-svitla-ternopil.pp.ua/" />
</head>
<body>

<div class="container">
    
    <div class="top-bar">
        <a href="matrix.html" class="btn-top">üìÖ –ü–æ–≤–Ω–∞ —Ç–∞–±–ª–∏—Ü—è</a>
        <a href="about.html" class="btn-top">‚ÑπÔ∏è –ü—Ä–æ –ø—Ä–æ—î–∫—Ç</a>
    </div>

    <header>
        <h1>–ì—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–≤—ñ—Ç–ª–∞ –¢–µ—Ä–Ω–æ–ø—ñ–ª—åüí°</h1>
        <div class="status-badge">
            <div id="statusDot" class="dot"></div>
            <span id="updateTime">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
        </div>
    </header>

    <div class="actions-grid">
        <a href="https://t.me/Grafik_Tern_bot" target="_blank" class="btn-main btn-tg">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69.01-.03.01-.14-.07-.2-.08-.06-.19-.04-.27-.02-.11.02-1.93 1.23-5.46 3.62-.51.35-.98.52-1.4.51-.46-.01-1.35-.26-2.01-.47-.81-.27-1.44-.41-1.38-.87.03-.24.38-.49 1.03-.75 4.06-1.77 6.77-2.94 8.13-3.51 3.87-1.63 4.67-1.91 5.2-1.91.11 0 .37.03.54.17.14.12.18.28.2.4.02.12.03.36.03.44z"/></svg>
            –ß–∞—Ç-–±–æ—Ç
        </a>
        <button onclick="openWiz()" class="btn-main btn-search">
            üîç –ó–Ω–∞–π—Ç–∏ —á–µ—Ä–≥—É
        </button>
    </div>

    <div class="scroller-container">
        <div class="group-track-wrapper">
            <div class="group-track" id="groupTrack"></div>
        </div>
        <div class="scroll-hint">(–ì–æ—Ä—Ç–∞–π—Ç–µ –≤–±—ñ–∫, —â–æ–± –æ–±—Ä–∞—Ç–∏ –≥—Ä—É–ø—É)</div>
    </div>

    <div class="card">
        
        <div class="day-switch">
            <button id="btnToday" class="day-opt active" onclick="setDay('today')">
                –°–¨–û–ì–û–î–ù–Ü
                <span id="dateToday">--.--.--</span>
            </button>
            <button id="btnTomorrow" class="day-opt" onclick="setDay('tomorrow')">
                –ó–ê–í–¢–†–ê
                <span id="dateTomorrow">--.--.--</span>
            </button>
        </div>

        <div id="noDataMsg" class="no-sched-msg">–ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ –∑–∞–≤—Ç—Ä–∞ —â–µ –Ω–µ –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ</div>

        <div class="group-display">
            <div class="group-display-label">–í–ê–®–ê –ß–ï–†–ì–ê</div>
            <div class="group-display-inner" id="groupDisplay">--</div>
        </div>

        <div id="scheduleContainer" class="schedule-list">
            <div class="empty-state">–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É –∑–≤–µ—Ä—Ö—É üëÜ</div>
        </div>

        <button class="btn-share" onclick="share()">üì§ –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –≥—Ä–∞—Ñ—ñ–∫–æ–º</button>
    </div>
    
    <footer>
        <h2>–ü—Ä–æ —Å–µ—Ä–≤—ñ—Å</h2>
        <p>–ì—Ä–∞—Ñ—ñ–∫ –ì–ü–í –í–ê–¢ "–¢–µ—Ä–Ω–æ–ø—ñ–ª—å–æ–±–ª–µ–Ω–µ—Ä–≥–æ". –î–∞–Ω—ñ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—é—Ç—å—Å—è.</p>
        <p style="margin-top:20px; font-size:11px;">¬© 2025 Grafik-Svitla-Ternopil.</p>
    </footer>

</div>

<div id="wiz" class="wiz-overlay" onclick="if(event.target===this)closeWiz()">
    <div class="wiz-box">
        <div class="wiz-head">
            <span id="wizTitle">–ü–æ—à—É–∫ —á–µ—Ä–≥–∏</span>
            <span class="wiz-close" onclick="closeWiz()">√ó</span>
        </div>
        <div class="wiz-body">
            
            <div id="step1" class="step-container">
                <div class="wiz-input-fixed">
                    <div class="wiz-input-wrap">
                        <span class="wiz-icon">üó∫</span>
                        <input id="inpDist" class="wiz-inp" placeholder="–û–±–µ—Ä—ñ—Ç—å —Ä–∞–π–æ–Ω –∑—ñ —Å–ø–∏—Å–∫—É..." autocomplete="off">
                    </div>
                </div>
                <div id="listDist" class="wiz-list-scroll"></div>
            </div>

            <div id="step2" class="step-container" style="display:none">
                <div class="wiz-input-fixed">
                    <div class="wiz-input-wrap">
                        <span class="wiz-icon">üèô</span>
                        <input id="inpCity" class="wiz-inp" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É (–Ω–∞–ø—Ä. –ì–∞—ó)" autocomplete="off">
                    </div>
                </div>
                <div id="listCity" class="wiz-list-scroll"></div>
                <div class="wiz-back" onclick="closeWiz(); openWiz()">‚Üê –ù–∞–∑–∞–¥ –¥–æ –≤–∏–±–æ—Ä—É —Ä–∞–π–æ–Ω—É</div>
            </div>

            <div id="step3" class="step-container" style="display:none">
                <div class="wiz-input-fixed">
                    <div class="wiz-input-wrap">
                        <span class="wiz-icon">üõ£</span>
                        <input id="inpStreet" class="wiz-inp" placeholder="–í–≤–µ–¥—ñ—Ç—å –≤—É–ª–∏—Ü—é" autocomplete="off">
                    </div>
                </div>
                <div id="listStreet" class="wiz-list-scroll"></div>
                <div class="wiz-back" onclick="backToStep(2)">‚Üê –ù–∞–∑–∞–¥ –¥–æ –≤–∏–±–æ—Ä—É –º—ñ—Å—Ç–∞</div>
            </div>

            <div id="step4" class="step-container" style="display:none">
                <div class="wiz-input-fixed">
                    <div class="wiz-input-wrap">
                        <span class="wiz-icon">üè†</span>
                        <input id="inpHouse" class="wiz-inp" placeholder="–ù–æ–º–µ—Ä –±—É–¥–∏–Ω–∫—É" autocomplete="off">
                    </div>
                </div>
                <div id="listHouse" class="wiz-list-scroll"></div>
                <div class="wiz-back" onclick="backToStep(3)">‚Üê –ù–∞–∑–∞–¥ –¥–æ –≤–∏–±–æ—Ä—É –≤—É–ª–∏—Ü—ñ</div>
            </div>

        </div>
    </div>
</div>

<script>
    // === CONFIG ===
    // –í–∞–∂–ª–∏–≤–æ: –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —Ñ–∞–π–ª addresses.json –Ω–∞ GitHub –º–∞—î –ø–∞—Ä–∞–º–µ—Ç—Ä "d" (—Ä–∞–π–æ–Ω)!
    const BASE_URL = 'https://raw.githubusercontent.com/kalyniak-gnostik/Svitlo_Ternopil/main';
    const CACHE = `?v=${Date.now()}`;
    const GROUPS = ["1.1", "1.2", "2.1", "2.2", "3.1", "3.2", "4.1", "4.2", "5.1", "5.2", "6.1", "6.2"];

    // === STATE ===
    let gData = { today: null, tomorrow: null, updated: '' };
    let gAddr = null;
    let currDay = 'today';
    let currGroup = new URLSearchParams(window.location.search).get('group') || localStorage.getItem('myGroup');
    
    // Search State
    let selDist = '';
    let selCity = '';
    let selStreet = '';

    // Infinite Scroll State
    let scrollerEl = null;
    let singleSetWidth = 0;

    // === INIT ===
    async function init() {
        setupInfiniteScroller();
        try {
            const [sRes, aRes] = await Promise.all([
                fetch(`${BASE_URL}/schedule.json${CACHE}`),
                fetch(`${BASE_URL}/addresses.json${CACHE}`)
            ]);
            if(aRes.ok) gAddr = await aRes.json();
            if(sRes.ok) {
                const raw = await sRes.json();
                processData(raw);
            }
        } catch(e) {
            console.error(e);
            document.getElementById('updateTime').innerText = "–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è";
            document.getElementById('statusDot').classList.add('error');
        }
        if(currGroup) selectGroup(currGroup);
    }

    // === SCROLLER LOGIC ===
    function setupInfiniteScroller() {
        scrollerEl = document.getElementById('groupTrack');
        scrollerEl.innerHTML = '';
        const tripleList = [...GROUPS, ...GROUPS, ...GROUPS];
        tripleList.forEach(g => {
            const b = document.createElement('div');
            b.className = 'btn-group';
            b.innerText = g;
            b.dataset.group = g; 
            b.onclick = () => selectGroup(g);
            scrollerEl.appendChild(b);
        });
        setTimeout(() => {
            if(scrollerEl.children.length > 0) {
                const itemW = scrollerEl.children[0].offsetWidth + 12;
                singleSetWidth = itemW * GROUPS.length;
                scrollerEl.scrollLeft = singleSetWidth;
                scrollerEl.addEventListener('scroll', handleLoopScroll);
                enableMomentum(scrollerEl);
            }
        }, 50);
    }
    function handleLoopScroll() {
        if (!singleSetWidth) return;
        const current = scrollerEl.scrollLeft;
        if (current < singleSetWidth / 2) {
            scrollerEl.scrollLeft += singleSetWidth;
        } else if (current > singleSetWidth * 1.5) {
            scrollerEl.scrollLeft -= singleSetWidth;
        }
    }
    function enableMomentum(el) {
        let isDown = false, startX, scrollLeft, velX = 0, animationID;
        el.addEventListener('mousedown', e => {
            isDown = true; el.classList.add('active');
            startX = e.pageX - el.offsetLeft; scrollLeft = el.scrollLeft;
            cancelAnimationFrame(animationID);
        });
        el.addEventListener('mouseleave', () => { isDown = false; el.classList.remove('active'); });
        el.addEventListener('mouseup', () => { isDown = false; el.classList.remove('active'); requestAnimationFrame(inertia); });
        el.addEventListener('mousemove', e => {
            if (!isDown) return; e.preventDefault();
            const x = e.pageX - el.offsetLeft;
            const walk = (x - startX) * 1.5;
            velX = (scrollLeft - walk) - el.scrollLeft;
            el.scrollLeft = scrollLeft - walk;
        });
        function inertia() {
            if (Math.abs(velX) < 0.1) return;
            el.scrollLeft += velX; velX *= 0.95;
            handleLoopScroll(); animationID = requestAnimationFrame(inertia);
        }
    }

    // === MAIN LOGIC ===
    function selectGroup(g) {
        currGroup = g;
        localStorage.setItem('myGroup', g);
        const newUrl = `${window.location.pathname}?group=${g}`;
        window.history.pushState({path: newUrl}, '', newUrl);
        document.querySelectorAll('.btn-group').forEach(b => {
            if(b.dataset.group === g) b.classList.add('active');
            else b.classList.remove('active');
        });
        renderCard();
    }

    function processData(raw) {
        const now = new Date();
        const dToday = fmtDateAPI(now);
        const dTom = fmtDateAPI(new Date(now.getTime() + 86400000));
        gData.updated = raw.updated_at;
        
        if(raw.today?.date === dToday) gData.today = raw.today;
        else if(raw.today?.date === dTom) gData.tomorrow = raw.today;
        if(raw.tomorrow?.date === dTom) gData.tomorrow = raw.tomorrow;
        else if(raw.tomorrow?.date === dToday && !gData.today) gData.today = raw.tomorrow;

        document.getElementById('updateTime').innerText = `–û–Ω–æ–≤–ª–µ–Ω–æ: ${gData.updated}`;
        document.getElementById('dateToday').innerText = gData.today ? fmtDateDisplay(gData.today.date) : fmtDateDisplay(dToday);
        document.getElementById('dateTomorrow').innerText = gData.tomorrow ? fmtDateDisplay(gData.tomorrow.date) : fmtDateDisplay(dTom);
        if(!gData.tomorrow) document.getElementById('btnTomorrow').classList.add('disabled');
        if(currGroup) selectGroup(currGroup);
    }

    function setDay(day) {
        const msg = document.getElementById('noDataMsg');
        if(day === 'tomorrow' && !gData.tomorrow) { msg.style.display = 'block'; return; }
        msg.style.display = 'none';
        currDay = day;
        document.getElementById('btnToday').classList.toggle('active', day === 'today');
        document.getElementById('btnTomorrow').classList.toggle('active', day === 'tomorrow');
        renderCard();
    }

    function renderCard() {
        const display = document.getElementById('groupDisplay');
        const list = document.getElementById('scheduleContainer');
        display.innerText = currGroup || '--';
        if(!currGroup) return;
        const dayData = gData[currDay];
        if(!dayData || !dayData.data[currGroup]) {
            list.innerHTML = `<div class="empty-state">–î–∞–Ω—ñ –≤—ñ–¥—Å—É—Ç–Ω—ñ</div>`; return;
        }
        const ranges = calcRanges(dayData.data[currGroup]);
        let html = '';
        ranges.forEach(r => {
            let cls = 'on', statusText = '–°–í–Ü–¢–õ–û –Ñ';
            if(r.type === 'off') { cls = 'off'; statusText = '–í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø'; }
            if(r.type === 'maybe') { cls = 'maybe'; statusText = '–ú–û–ñ–õ–ò–í–û'; }
            html += `<div class="row ${cls}"><div class="time-box"><div>${r.start}</div><div style="font-size:10px; opacity:0.6; margin:2px 0;">‚Üì</div><div>${r.end}</div></div><div class="status-box"><div><div>${statusText}</div><div class="row-dur">${r.dur}</div></div><div style="font-size:20px">${r.type==='off'?'‚ö°Ô∏è':(r.type==='maybe'?'‚ö†Ô∏è':'üí°')}</div></div></div>`;
        });
        list.innerHTML = html;
    }

    function fmtDateAPI(d) { return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`; }
    function fmtDateDisplay(d) { if(!d) return '--.--.----'; if(d.length<=5) return `${d}.${new Date().getFullYear()}`; return d; }
    function calcRanges(sched) {
        const times = Object.keys(sched).sort();
        let res = [], start = null, cur = null;
        for (let t of times) {
            let type = sched[t];
            if (type !== cur) {
                if (cur) res.push({start, end:t, type:cur, dur: getDur(start, t)});
                start = t; cur = type;
            }
        }
        if (cur) res.push({start, end:'24:00', type:cur, dur: getDur(start, '24:00')});
        return res;
    }
    function getDur(s, e) {
        const [h1, m1] = s.split(':').map(Number);
        const [h2, m2] = e.split(':').map(Number);
        let min = (h2*60+m2) - (h1*60+m1); if(min < 0) min += 1440;
        const h = Math.floor(min/60), m = min%60;
        return h>0 ? (m>0 ? `${h}–≥ ${m}—Ö–≤` : `${h} –≥–æ–¥`) : `${m} —Ö–≤`;
    }
    function share() {
        if(!currGroup) return;
        const text = `–ì—Ä–∞—Ñ—ñ–∫ —á–µ—Ä–≥–∏ ${currGroup}. ${window.location.href}`;
        if(navigator.share) navigator.share({title:'–°–≤—ñ—Ç–ª–æ', text, url: window.location.href});
        else { navigator.clipboard.writeText(window.location.href); alert('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ'); }
    }

    // === NEW WIZARD LOGIC (Multi-step Search) ===
    
    function openWiz() { 
        if(!gAddr) { alert('–ë–∞–∑–∞ –∞–¥—Ä–µ—Å –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è...'); return; }
        document.getElementById('wiz').style.display = 'flex';
        
        // 1. –û—Ç—Ä–∏–º—É—î–º–æ —Ä–∞–π–æ–Ω–∏
        // –£–í–ê–ì–ê: –Ø–∫—â–æ —Ç—É—Ç –ø–æ—Ä–æ–∂–Ω—å–æ, –∑–Ω–∞—á–∏—Ç—å —Ñ–∞–π–ª JSON —â–µ —Å—Ç–∞—Ä–∏–π (–±–µ–∑ "d").
        const districts = [...new Set(gAddr.map(x => x.d).filter(Boolean))].sort();
        
        setupSearch('inpDist', 'listDist', () => districts, setDistrict);
        renderList('listDist', districts, setDistrict);

        // –Ø–∫—â–æ —Å–ø–∏—Å–æ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π - —Å–ø—Ä–æ–±—É—î–º–æ –ø–æ–∫–∞–∑–∞—Ç–∏ —Ü–µ
        if(districts.length === 0) {
            document.getElementById('listDist').innerHTML = '<div style="padding:20px; text-align:center; color:red">–ü–æ–º–∏–ª–∫–∞ –¥–∞–Ω–∏—Ö! <br> –§–∞–π–ª –∞–¥—Ä–µ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ —Å—Ç–∞—Ä–∏–π (–±–µ–∑ —Ä–∞–π–æ–Ω—ñ–≤). <br> –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –Ω–æ–≤–∏–π addresses.json –Ω–∞ GitHub.</div>';
        }
    }
    
    function closeWiz() { 
        document.getElementById('wiz').style.display = 'none'; 
        backToStep(1); // Reset to first step
    }

    function backToStep(n) {
        ['step1','step2','step3','step4'].forEach(id => document.getElementById(id).style.display = 'none');
        document.getElementById(`step${n}`).style.display = 'flex'; // Changed to flex for proper layout
        
        if(n <= 1) document.getElementById('inpDist').value = '';
        if(n <= 2) document.getElementById('inpCity').value = '';
        if(n <= 3) document.getElementById('inpStreet').value = '';
        
        let title = '–ü–æ—à—É–∫ —á–µ—Ä–≥–∏';
        if(n===1) title = '–û–±–µ—Ä—ñ—Ç—å —Ä–∞–π–æ–Ω';
        if(n===2) title = '–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ';
        if(n===3) title = '–û–±–µ—Ä—ñ—Ç—å –≤—É–ª–∏—Ü—é';
        if(n===4) title = '–û–±–µ—Ä—ñ—Ç—å –±—É–¥–∏–Ω–æ–∫';
        document.getElementById('wizTitle').innerText = title;

        // Re-render lists for previous steps to ensure they are populated
        if(n===2) {
             const cities = [...new Set(gAddr.filter(x => x.d === selDist).map(x => x.c))].sort();
             setupSearch('inpCity', 'listCity', () => cities, setCity);
             renderList('listCity', cities, setCity);
        }
        if(n===3) {
             const streets = [...new Set(gAddr.filter(x => x.d === selDist && x.c === selCity).map(x => x.s))].sort();
             setupSearch('inpStreet', 'listStreet', () => streets, setStreet);
             renderList('listStreet', streets, setStreet);
        }
    }

    // Generic Search Setup
    function setupSearch(inpId, listId, dataFn, cb) {
        const inp = document.getElementById(inpId);
        inp.oninput = (e) => {
            const v = e.target.value.toLowerCase();
            const list = dataFn().filter(x => x.toLowerCase().includes(v));
            renderList(listId, list, cb);
        };
        // Trigger immediately just in case
        const list = dataFn();
        renderList(listId, list, cb);
    }

    function renderList(id, arr, cb) {
        const el = document.getElementById(id); el.innerHTML = '';
        if(arr.length === 0) el.innerHTML = '<div style="padding:15px; color:var(--text-sub); font-style:italic; text-align:center;">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';
        
        // –õ—ñ–º—ñ—Ç —Ä–µ–Ω–¥–µ—Ä—É (—à–≤–∏–¥–∫–æ–¥—ñ—è)
        arr.slice(0, 200).forEach(x => {
            const d = document.createElement('div');
            d.className = 'wiz-item'; d.innerText = x;
            d.onclick = () => cb(x);
            el.appendChild(d);
        });
    }

    // Step 1: District
    function setDistrict(d) {
        selDist = d;
        document.getElementById('inpDist').value = d;
        document.getElementById('step1').style.display = 'none';
        document.getElementById('step2').style.display = 'flex'; // Use flex for layout
        document.getElementById('wizTitle').innerText = '–í–≤–µ–¥—ñ—Ç—å –º—ñ—Å—Ç–æ';
        
        const cities = [...new Set(gAddr.filter(x => x.d === selDist).map(x => x.c))].sort();
        setupSearch('inpCity', 'listCity', () => cities, setCity);
        renderList('listCity', cities, setCity);
    }

    // Step 2: City
    function setCity(c) {
        selCity = c; 
        document.getElementById('inpCity').value = c;
        document.getElementById('step2').style.display = 'none';
        document.getElementById('step3').style.display = 'flex';
        document.getElementById('wizTitle').innerText = '–í—É–ª–∏—Ü—è';

        const streets = [...new Set(gAddr.filter(x => x.d === selDist && x.c === selCity).map(x => x.s))].sort();
        setupSearch('inpStreet', 'listStreet', () => streets, setStreet);
        renderList('listStreet', streets, setStreet);
    }

    // Step 3: Street
// Step 3: Street (–û–Ω–æ–≤–ª–µ–Ω–∞ –ª–æ–≥—ñ–∫–∞ –∑ –∞–≤—Ç–æ-–≤–∏–±–æ—Ä–æ–º "–í—Å—ñ")
// Step 3: Street (–§—ñ–Ω–∞–ª—å–Ω–∞ –≤–µ—Ä—Å—ñ—è –∑ –ø–æ–∫—Ä–∞—â–µ–Ω–∏–º —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è–º "–í—Å—ñ")
    function setStreet(s) {
        selStreet = s;
        document.getElementById('inpStreet').value = s;
        document.getElementById('step3').style.display = 'none';
        
        // 1. –ó–Ω–∞—Ö–æ–¥–∏–º–æ –±—É–¥–∏–Ω–∫–∏
        const rows = gAddr.filter(x => x.d === selDist && x.c === selCity && x.s === selStreet);
        
        let houseList = [];
        rows.forEach(r => {
            if(Array.isArray(r.h)) {
                r.h.forEach(hNum => houseList.push({ num: hNum, grp: r.g }));
            } else {
                houseList.push({ num: r.h, grp: r.g });
            }
        });

        // 2. –°–æ—Ä—Ç—É—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ
        const uniqueH = [...new Set(houseList.map(x => x.num))].sort((a,b) => 
            a.toString().localeCompare(b.toString(), undefined, {numeric: true})
        );
        
        // === –õ–û–ì–Ü–ö–ê –ê–í–¢–û-–ü–ï–†–ï–•–û–î–£ ===
        // –Ø–∫—â–æ —É —Å–ø–∏—Å–∫—É –ª–∏—à–µ –æ–¥–∏–Ω –ø—É–Ω–∫—Ç
        if (uniqueH.length === 1) {
            const val = String(uniqueH[0]).toLowerCase().trim();

            // –¶–µ–π —Ä–µ–≥—É–ª—è—Ä–Ω–∏–π –≤–∏—Ä–∞–∑ –ª–æ–≤–∏—Ç—å:
            // "–≤—Å—ñ", "–≤—Åi" (–ª–∞—Ç–∏–Ω—Å—å–∫–∞ i), "bci" (–≤—Å–µ –ª–∞—Ç–∏–Ω–∏—Ü–µ—é), 
            // "—É—Å—ñ", "all", "–≤–≤–µ—Å—å", "–≤–µ—Å—å"
            const isAll = /^(–≤—Å—ñ|–≤—Åi|bci|bc—ñ|—É—Å—ñ|—É—Åi|all|default|–≤–≤–µ—Å—å|whole)/i.test(val);

            if (isAll) {
                finish(houseList[0].grp);
                return; // –ó—É–ø–∏–Ω—è—î–º–æ —Ä–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫—É
            }
        }
        // ============================

        document.getElementById('step4').style.display = 'flex';
        document.getElementById('wizTitle').innerText = '–û–±–µ—Ä—ñ—Ç—å –±—É–¥–∏–Ω–æ–∫';

        setupSearch('inpHouse', 'listHouse', () => uniqueH, (hVal) => {
            const match = rows.find(r => {
                 if(Array.isArray(r.h)) return r.h.includes(hVal);
                 return r.h === hVal;
            });
            if(match) finish(match.g);
        });
        
        renderList('listHouse', uniqueH, (hVal) => {
             const match = rows.find(r => {
                 if(Array.isArray(r.h)) return r.h.includes(hVal);
                 return r.h === hVal;
            });
            if(match) finish(match.g);
        });
    }

    init();
</script>
</body>
</html>
